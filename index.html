<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UNEB Analytics System</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>

:root{
  --primary:#0f172a;
  --accent:#2563eb;
  --light:#f1f5f9;
}

body{
  font-family:"Segoe UI",Arial,sans-serif;
  margin:0;
  background:var(--light);
}

/* LOGIN */
#loginBox{
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:linear-gradient(135deg,#1e293b,#0f172a);
}

.login-card{
  background:white;
  padding:30px;
  border-radius:12px;
  width:320px;
  text-align:center;
  box-shadow:0 10px 25px rgba(0,0,0,0.3);
}

.login-card input{
  width:90%;
  padding:8px;
  margin:8px 0;
  border-radius:6px;
  border:1px solid #cbd5e1;
}

button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  background:var(--accent);
  color:white;
  font-weight:600;
  cursor:pointer;
}

button:hover{
  background:#1d4ed8;
}

/* APP */
#app{
  display:none;
  padding:20px;
}

input{
  padding:6px;
  margin:4px;
  border-radius:6px;
  border:1px solid #cbd5e1;
}

.report-box{
  background:white;
  padding:15px;
  border-radius:10px;
  box-shadow:0 5px 20px rgba(0,0,0,0.1);
  position:relative;
  min-height:90vh;
}

/* HEADER */
.report-header{
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  margin-bottom:10px;
}

.logo-container{
  position:absolute;
  left:0;
}

.logo-container img{
  height:70px;
  width:auto;
}

.school-info{
  text-align:center;
}

.school-info h2{
  margin:0;
  font-size:22px;
}

.school-info h3{
  margin:0;
  font-size:15px;
  color:#475569;
}

/* TABLES */
table{
  width:100%;
  border-collapse:collapse;
  font-size:10px;
  margin-top:5px;
}

th{
  background:var(--primary);
  color:white;
  padding:4px;
}

td{
  padding:3px;
  text-align:center;
}

th,td{
  border:1px solid #cbd5e1;
}

tr:nth-child(even){
  background:#f8fafc;
}

tfoot td{
  font-weight:bold;
  background:#e2e8f0;
}

/* SUMMARY */
.summary-cards{
  display:flex;
  justify-content:center;
  gap:20px;
  margin-top:8px;
  font-weight:bold;
}

.card{
  background:#e0f2fe;
  padding:6px 12px;
  border-radius:6px;
}

/* SIGNATURE */
.signature{
  position:absolute;
  bottom:15px;
  left:20px;
  font-size:11px;
}

/* PRINT SETTINGS */
@page{
  size:A4 landscape;
  margin:8mm;
}

@media print{

  button,input{
    display:none;
  }

  table{
    font-size:9px;
  }

  .report-box{
    box-shadow:none;
  }

  .signature{
    position:absolute;
    bottom:10mm;
    left:15mm;
  }

  *{
    page-break-inside:avoid !important;
  }
}

</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox">
  <div class="login-card">
    <h2>UNEB Analytics Login</h2>
    <input id="username" placeholder="Username"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>
</div>

<!-- APP -->
<div id="app">

<div style="margin-bottom:10px;">
<input id="schoolName" placeholder="School Name">
<input id="year" placeholder="Year">
<input type="file" id="logoUpload" accept="image/*">
<input type="file" id="file" accept=".xlsx,.xls">
<button onclick="generateReport()">Generate Report</button>
<button onclick="printReport()">Print</button>
<button onclick="downloadPDF()">Export PDF</button>
<button onclick="exportExcel()">Export Excel</button>
</div>

<div id="reportArea" class="report-box">

<div class="report-header">
  <div class="logo-container">
    <img id="schoolLogo" style="display:none;">
  </div>
  <div class="school-info">
    <h2 id="schoolTitle">SCHOOL NAME</h2>
    <h3 id="schoolYear">UNEB PERFORMANCE REPORT</h3>
  </div>
</div>

<div id="subjectSummary"></div>
<div id="genderSummary"></div>
<div id="analytics"></div>

<div class="signature">
Signature: ___________________________<br><br>
<strong>MAWERERE FRANCIS</strong><br>
In charge Students Data<br>
Contact: 0788222315<br>
Email: mawererefrancis@gmail.com
</div>

</div>
</div>

<script>

/* LOGIN */
function login(){
 if(username.value==="admin" && password.value==="1234"){
  loginBox.style.display="none";
  app.style.display="block";
 }else{
  loginError.innerText="Use admin / 1234";
 }
}

/* LOGO UPLOAD */
document.getElementById("logoUpload").addEventListener("change", function(e){
 const reader = new FileReader();
 reader.onload = function(){
   const logo = document.getElementById("schoolLogo");
   logo.src = reader.result;
   logo.style.display="block";
 }
 reader.readAsDataURL(e.target.files[0]);
});

let subjects={}, gender={};

function generateReport(){

 const file=document.getElementById("file").files[0];
 if(!file){ alert("Upload Excel file"); return; }

 document.getElementById("schoolTitle").innerText =
   schoolName.value || "SCHOOL NAME";

 document.getElementById("schoolYear").innerText =
   "UNEB PERFORMANCE REPORT – " + (year.value||"");

 const reader=new FileReader();

 reader.onload=e=>{
  const wb=XLSX.read(e.target.result,{type:"array"});
  const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

  subjects={}; gender={};

  rows.forEach(row=>{
   const sex=String(row.Sex||"").toUpperCase().trim();
   const project=String(row["PROJECT WORK"]||"X").toUpperCase().trim();
   const achievements=String(row["SUBJECT ACHIEVEMENTS"]||"").trim();
   if(!achievements) return;

   const valid=["A","B","C","D","E","X"];
   const pg=valid.includes(project)?project:"X";

   achievements.split(" ").forEach(item=>{
     if(!item.includes("-")) return;
     const [subjectRaw,gradeRaw]=item.split("-");
     const subject=subjectRaw.toUpperCase().trim();
     const g=valid.includes(gradeRaw)?gradeRaw:"X";

     if(!subjects[subject]){
       subjects[subject]={sat:0,A:0,B:0,C:0,D:0,E:0,X:0};
     }

     subjects[subject].sat++;
     subjects[subject][g]++;

     if(!gender[subject]){
       gender[subject]={MA:0,MB:0,MC:0,MD:0,ME:0,FA:0,FB:0,FC:0,FD:0,FE:0};
     }

     if(sex==="M"&&g!=="X") gender[subject]["M"+g]++;
     if(sex==="F"&&g!=="X") gender[subject]["F"+g]++;
   });
  });

  renderSubject();
  renderGender();
  renderAnalytics();
 };

 reader.readAsArrayBuffer(file);
}

/* SUBJECT TABLE */
function renderSubject(){

 let h=`<h3 style="text-align:center;">Subject Summary</h3>
 <table>
 <tr>
 <th>Subject</th><th>Sat</th>
 <th>A</th><th>B</th><th>C</th>
 <th>D</th><th>E</th><th>X</th>
 </tr>`;

 Object.keys(subjects).forEach(s=>{
  let x=subjects[s];
  h+=`<tr>
  <td>${s}</td><td>${x.sat}</td>
  <td>${x.A}</td><td>${x.B}</td><td>${x.C}</td>
  <td>${x.D}</td><td>${x.E}</td><td>${x.X}</td>
  </tr>`;
 });

 h+=`</table>`;
 subjectSummary.innerHTML=h;
}

/* GENDER TABLE */
function renderGender(){

 let h=`<h3 style="text-align:center;">Gender Summary</h3>
 <table>
 <tr>
 <th>Subject</th>
 <th>MA</th><th>MB</th><th>MC</th>
 <th>MD</th><th>ME</th>
 <th>FA</th><th>FB</th>
 <th>FC</th><th>FD</th><th>FE</th>
 </tr>`;

 Object.keys(gender).forEach(s=>{
  let g=gender[s];
  h+=`<tr>
  <td>${s}</td>
  <td>${g.MA}</td><td
